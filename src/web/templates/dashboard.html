{% extends "base.html" %}

{% block title %}Resumen de Inventario · Inventario Contifico{% endblock %}

{% block content %}
<section class="hero">
  <h2 class="hero__title">Resumen del inventario sincronizado</h2>
  <p class="hero__subtitle">
    Consulta el estado actual de los catálogos y documentos obtenidos desde Contífico.
  </p>
</section>

<section class="sync">
  <h2>Sincroniza tu inventario</h2>
  <p>
    Lanza una sincronización inmediata contra la API de Contífico para refrescar los datos
    almacenados en esta instancia.
  </p>
  <form id="sync-form" class="sync__form">
    <label class="sync__label" for="since">Importar cambios desde (opcional)</label>
    <input
      id="since"
      name="since"
      type="datetime-local"
      class="sync__input"
      placeholder="2024-01-01T00:00"
    />
    <fieldset class="sync__fieldset">
      <legend>¿Qué deseas sincronizar?</legend>
      <p class="sync__hint">Deja las casillas vacías para importar todos los módulos.</p>
      <div class="sync__options">
        {% for option in resource_options %}
        <label class="sync__checkbox">
          <input type="checkbox" name="resources" value="{{ option.slug }}" />
          <span>{{ option.label }}</span>
        </label>
        {% endfor %}
      </div>
      <div class="sync__actions">
        <button type="button" class="sync__toggle" data-action="select-all">
          Seleccionar todo
        </button>
        <button type="button" class="sync__toggle" data-action="clear-all">
          Limpiar selección
        </button>
      </div>
    </fieldset>
    <label class="sync__checkbox sync__checkbox--single">
      <input type="checkbox" name="full_refresh" value="1" />
      <span>Descargar todo otra vez (ignora la última sincronización)</span>
    </label>
    <button type="submit" class="sync__button">Sincronizar ahora</button>
  </form>
  <p id="sync-status" class="sync__status" role="status"></p>
</section>

<section class="lookup">
  <h2>Busca registros descargados</h2>
  <p>
    Valida la sincronización consultando los últimos registros o buscando por identificador o
    palabra clave en los datos descargados.
  </p>
  <form id="lookup-form" class="lookup__form">
    <label class="lookup__label" for="lookup-resource">Recurso</label>
    <select id="lookup-resource" name="resource" class="lookup__input" required>
      <option value="" disabled selected>Selecciona un recurso</option>
      {% for option in resource_options %}
      <option value="{{ option.slug }}">{{ option.label }}</option>
      {% endfor %}
    </select>
    <label class="lookup__label" for="lookup-query">Término de búsqueda (opcional)</label>
    <input
      id="lookup-query"
      name="query"
      type="text"
      class="lookup__input"
      placeholder="ID exacto o palabra clave"
    />
    <div class="lookup__actions">
      <button type="submit" class="lookup__button lookup__button--primary">Buscar</button>
      <button
        type="button"
        id="sample-button"
        class="lookup__button lookup__button--secondary"
      >
        Copiar muestra
      </button>
    </div>
  </form>
  <div id="lookup-status" class="lookup__status" role="status"></div>
  <div id="lookup-results" class="lookup__results" hidden>
    <h3 class="lookup__results-title">Coincidencias</h3>
    <ul class="lookup__list"></ul>
  </div>
  <div id="sample-status" class="lookup__status lookup__status--sample" role="status"></div>
  <div id="sample-output" class="lookup__sample" hidden>
    <div class="lookup__sample-header">
      <h3 class="lookup__sample-title">Muestra lista para compartir</h3>
      <button type="button" id="sample-copy" class="lookup__button lookup__button--ghost">
        Copiar de nuevo
      </button>
    </div>
    <textarea
      id="sample-payload"
      class="lookup__sample-text"
      rows="8"
      readonly
      aria-label="Contenido de la muestra para copiar"
    ></textarea>
    <p class="lookup__sample-hint">
      Cuando generes la muestra se copiará automáticamente al portapapeles.
      Si falla, selecciona el contenido manualmente o usa el botón «Copiar de nuevo».
    </p>
  </div>
</section>

<section class="cards">
  {% for resource in resources %}
  <article class="card">
    <header class="card__header">
      <h3>{{ resource.label }}</h3>
      <span class="card__count">{{ resource.count }}</span>
    </header>
    <dl class="card__meta">
      <div>
        <dt>Última actualización (API)</dt>
        <dd>{{ resource.last_updated or "Sin datos" }}</dd>
      </div>
      <div>
        <dt>Última captura (local)</dt>
        <dd>{{ resource.last_fetched or "Sin datos" }}</dd>
      </div>
      <div>
        <dt>Última sincronización</dt>
        <dd>{{ resource.last_synced or "Sin registros" }}</dd>
      </div>
    </dl>
  </article>
  {% endfor %}

  {% if not has_data %}
  <article class="card card--empty">
    <h3>Aún no hay datos</h3>
    <p>
      Realiza una sincronización desde el panel para poblar la base local y comenzar a construir
      análisis desde este panel.
    </p>
  </article>
  {% endif %}
</section>

<section class="upcoming">
  <h2>Próximas funcionalidades</h2>
  <p>Estas ideas guiarán los análisis y visualizaciones que añadiremos sobre el inventario.</p>
  <ul class="upcoming__list">
    {% for item in upcoming %}
    <li>
      <h3>{{ item.title }}</h3>
      <p>{{ item.description }}</p>
    </li>
    {% endfor %}
  </ul>
</section>

{% block scripts %}
<script>
  const syncForm = document.querySelector('#sync-form');
  const syncStatus = document.querySelector('#sync-status');
  const lookupForm = document.querySelector('#lookup-form');
  const lookupStatus = document.querySelector('#lookup-status');
  const lookupResults = document.querySelector('#lookup-results');
  const lookupList = lookupResults ? lookupResults.querySelector('.lookup__list') : null;
  const lookupResource = lookupForm ? lookupForm.querySelector('#lookup-resource') : null;
  const sampleButton = document.querySelector('#sample-button');
  const sampleStatus = document.querySelector('#sample-status');
  const sampleOutput = document.querySelector('#sample-output');
  const sampleTextarea = document.querySelector('#sample-payload');
  const sampleCopyButton = document.querySelector('#sample-copy');

  if (syncForm) {
    syncForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      syncStatus.textContent = 'Lanzando sincronización…';

      const formData = new FormData(syncForm);
      const params = new URLSearchParams();
      const since = formData.get('since');
      if (since) {
        params.append('since', since);
      }
      formData
        .getAll('resources')
        .filter((value) => value)
        .forEach((value) => params.append('resources', value));
      if (formData.get('full_refresh')) {
        params.append('full_refresh', 'true');
      }

      try {
        const queryString = params.toString();
        const response = await fetch(`/api/sync${queryString ? `?${queryString}` : ''}`, {
          method: 'POST',
        });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'No se pudo iniciar la sincronización');
        }
        const payload = await response.json();
        syncStatus.textContent = `✔ ${payload.detail}. Puedes refrescar la página en unos minutos para ver los resultados.`;
      } catch (error) {
        syncStatus.textContent = `✖ ${error.message}`;
      }
    });

    const toggleButtons = syncForm.querySelectorAll('.sync__toggle');
    const resourceCheckboxes = syncForm.querySelectorAll('input[name="resources"]');
    toggleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const action = button.dataset.action;
        resourceCheckboxes.forEach((checkbox) => {
          if (action === 'select-all') {
            checkbox.checked = true;
          }
          if (action === 'clear-all') {
            checkbox.checked = false;
          }
        });
      });
    });
  }

  const IDENTIFIER_FIELDS = {
    products: { label: 'Código', fields: ['codigo', 'product_code', 'producto_codigo', 'sku', 'code'] },
    variants: { label: 'Código', fields: ['codigo', 'code', 'sku', 'product_code', 'producto_codigo'] },
    purchases: {
      label: 'Número',
      fields: ['numero', 'numero_documento', 'documento_numero', 'number', 'comprobante_numero'],
    },
    sales: {
      label: 'Número',
      fields: ['numero', 'number', 'documento_numero', 'comprobante_numero', 'secuencial'],
    },
    documents: { label: 'Número', fields: ['numero', 'number', 'documento_numero'] },
    remission_guides: { label: 'Número', fields: ['numero', 'number', 'guia_numero'] },
    registry_transactions: { label: 'Número', fields: ['numero', 'number', 'documento_numero'] },
  };

  const COMMON_IDENTIFIER_FIELDS = [
    'codigo',
    'codigo_principal',
    'codigoAuxiliar',
    'product_code',
    'producto_codigo',
    'sku',
    'numero',
    'number',
    'name',
    'nombre',
  ];

  const normaliseIdentifierValue = (value) => {
    if (value === null || value === undefined) {
      return null;
    }
    if (typeof value === 'string') {
      const trimmed = value.trim();
      return trimmed || null;
    }
    if (typeof value === 'number' || typeof value === 'bigint') {
      return `${value}`;
    }
    if (typeof value.toString === 'function') {
      const text = value.toString();
      return text && text !== '[object Object]' ? text : null;
    }
    return null;
  };

  const deriveIdentifier = (resource, item) => {
    const payload = item && typeof item === 'object' ? item.data || {} : {};
    const config = IDENTIFIER_FIELDS[resource] || { label: 'ID', fields: [] };
    const candidates = [...config.fields, ...COMMON_IDENTIFIER_FIELDS];
    for (const field of candidates) {
      if (!payload || typeof payload !== 'object') {
        break;
      }
      const value = normaliseIdentifierValue(payload[field]);
      if (value) {
        return { label: config.label, value };
      }
    }
    return null;
  };

  if (lookupForm && lookupStatus && lookupResults && lookupList) {
    lookupForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(lookupForm);
      const resource = formData.get('resource');
      const query = formData.get('query');
      if (!resource) {
        lookupStatus.textContent = 'Selecciona un recurso para buscar.';
        return;
      }

      lookupStatus.textContent = 'Buscando…';
      lookupResults.hidden = true;
      lookupList.innerHTML = '';

      try {
        const params = new URLSearchParams();
        if (query) {
          params.append('q', query);
        }
        const response = await fetch(
          `/api/resource/${encodeURIComponent(resource)}${params.toString() ? `?${params}` : ''}`
        );
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.detail || 'No se pudo realizar la búsqueda');
        }
        const payload = await response.json();
        const { results } = payload;
        if (!results || results.length === 0) {
          lookupStatus.textContent = 'No se encontraron coincidencias con los criterios proporcionados.';
          return;
        }

        lookupStatus.textContent = `Se encontraron ${results.length} coincidencia(s).`;
        results.forEach((item) => {
          const element = document.createElement('li');
          element.classList.add('lookup__item');
          const title = document.createElement('h4');
          const identifier = deriveIdentifier(resource, item);
          if (identifier) {
            title.textContent = `${identifier.label}: ${identifier.value}`;
          } else if (item.id) {
            title.textContent = `ID: ${item.id}`;
          } else {
            title.textContent = 'Sin identificador';
          }
          element.appendChild(title);
          const meta = document.createElement('p');
          meta.classList.add('lookup__meta');
          const updated = item.updated_at ? new Date(item.updated_at).toLocaleString() : 'Desconocido';
          const fetched = item.fetched_at ? new Date(item.fetched_at).toLocaleString() : 'Desconocido';
          const metaParts = [`Actualizado: ${updated}`, `Capturado: ${fetched}`];
          if (item.id && (!identifier || identifier.value !== item.id)) {
            metaParts.push(`ID interno: ${item.id}`);
          }
          meta.textContent = metaParts.join(' · ');
          element.appendChild(meta);
          const pre = document.createElement('pre');
          pre.classList.add('lookup__payload');
          pre.textContent = JSON.stringify(item.data, null, 2);
          element.appendChild(pre);
          lookupList.appendChild(element);
        });
        lookupResults.hidden = false;
      } catch (error) {
        lookupStatus.textContent = `Error: ${error.message}`;
      }
    });
  }

  if (
    lookupForm &&
    lookupResource &&
    sampleButton &&
    sampleStatus &&
    sampleOutput &&
    sampleTextarea &&
    sampleCopyButton
  ) {
    const buildSampleText = (payload) => {
      const { limit, resources } = payload;
      const header = `Muestra consolidada (máximo ${limit} registro(s) por módulo)`;
      const sections = (resources || []).map((entry) => {
        const { resource, label, count, results } = entry;
        const simplified = (results || []).map((item) => ({
          id: item.id,
          updated_at: item.updated_at,
          fetched_at: item.fetched_at,
          data: item.data,
        }));
        const sectionHeader = `Recurso: ${label || resource} (${resource})`;
        const countLine = `Registros en muestra: ${count}`;
        const body =
          simplified.length > 0
            ? JSON.stringify(simplified, null, 2)
            : 'Sin datos disponibles.';
        return `${sectionHeader}\n${countLine}\n${body}`;
      });
      return [header, ...sections].join('\n\n');
    };

    sampleButton.addEventListener('click', async () => {
      sampleStatus.textContent = 'Generando muestra…';
      sampleOutput.hidden = true;
      sampleTextarea.value = '';

      try {
        const response = await fetch('/api/resources/sample');
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.detail || 'No se pudo generar la muestra');
        }
        const payload = await response.json();
        const { resources } = payload;
        const total = (resources || []).reduce(
          (acc, entry) => acc + (entry?.count || 0),
          0
        );
        if (!total) {
          sampleStatus.textContent =
            'Todavía no hay registros sincronizados para generar la muestra consolidada.';
          return;
        }

        const clipboardText = buildSampleText(payload);
        sampleTextarea.value = clipboardText;
        sampleOutput.hidden = false;

        let copied = false;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(clipboardText);
            sampleStatus.textContent = '✔ Muestra copiada al portapapeles. ¡Lista para compartir!';
            copied = true;
          } catch (copyError) {
            console.warn('No se pudo copiar automáticamente la muestra', copyError);
          }
        }

        if (!copied) {
          sampleStatus.textContent =
            'Muestra generada. Copia manualmente el contenido o usa «Copiar de nuevo».';
        }
      } catch (error) {
        sampleStatus.textContent = `Error: ${error.message}`;
        sampleOutput.hidden = true;
        sampleTextarea.value = '';
      }
    });

    sampleCopyButton.addEventListener('click', async () => {
      const content = sampleTextarea.value;
      if (!content) {
        sampleStatus.textContent = 'Genera una muestra antes de copiarla.';
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(content);
          sampleStatus.textContent = '✔ Muestra copiada nuevamente al portapapeles.';
          return;
        } catch (error) {
          console.warn('No se pudo copiar la muestra al portapapeles', error);
        }
      }

      sampleStatus.textContent = 'No se pudo copiar automáticamente. Selecciona el texto manualmente.';
    });
  }
</script>
{% endblock %}
{% endblock %}
