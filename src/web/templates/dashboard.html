{% extends "base.html" %}

{% block title %}Resumen de Inventario · Inventario Contifico{% endblock %}

{% block content %}
<section class="hero">
  <h2 class="hero__title">Resumen del inventario sincronizado</h2>
  <p class="hero__subtitle">
    Consulta el estado actual de los catálogos y movimientos obtenidos desde Contífico.
  </p>
</section>

<section class="sync">
  <h2>Sincroniza tu inventario</h2>
  <p>
    Lanza una sincronización inmediata contra la API de Contífico para refrescar los datos
    almacenados en esta instancia.
  </p>
  <form id="sync-form" class="sync__form">
    <label class="sync__label" for="since">Importar cambios desde (opcional)</label>
    <input
      id="since"
      name="since"
      type="datetime-local"
      class="sync__input"
      placeholder="2024-01-01T00:00"
    />
    <button type="submit" class="sync__button">Sincronizar ahora</button>
  </form>
  <p id="sync-status" class="sync__status" role="status"></p>
</section>

<section class="cards">
  {% for resource in resources %}
  <article class="card">
    <header class="card__header">
      <h3>{{ resource.label }}</h3>
      <span class="card__count">{{ resource.count }}</span>
    </header>
    <dl class="card__meta">
      <div>
        <dt>Última actualización (API)</dt>
        <dd>{{ resource.last_updated or "Sin datos" }}</dd>
      </div>
      <div>
        <dt>Última captura (local)</dt>
        <dd>{{ resource.last_fetched or "Sin datos" }}</dd>
      </div>
      <div>
        <dt>Última sincronización</dt>
        <dd>{{ resource.last_synced or "Sin registros" }}</dd>
      </div>
    </dl>
  </article>
  {% endfor %}

  {% if not has_data %}
  <article class="card card--empty">
    <h3>Aún no hay datos</h3>
    <p>
      Realiza una sincronización desde el panel para poblar la base local y comenzar a construir
      análisis desde este panel.
    </p>
  </article>
  {% endif %}
</section>

<section class="upcoming">
  <h2>Próximas funcionalidades</h2>
  <p>Estas ideas guiarán los análisis y visualizaciones que añadiremos sobre el inventario.</p>
  <ul class="upcoming__list">
    {% for item in upcoming %}
    <li>
      <h3>{{ item.title }}</h3>
      <p>{{ item.description }}</p>
    </li>
    {% endfor %}
  </ul>
</section>

{% block scripts %}
<script>
  const syncForm = document.querySelector('#sync-form');
  const syncStatus = document.querySelector('#sync-status');

  if (syncForm) {
    syncForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      syncStatus.textContent = 'Lanzando sincronización…';

      const formData = new FormData(syncForm);
      const since = formData.get('since');
      const params = since ? `?since=${encodeURIComponent(since)}` : '';

      try {
        const response = await fetch(`/api/sync${params}`, { method: 'POST' });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'No se pudo iniciar la sincronización');
        }
        const payload = await response.json();
        syncStatus.textContent = `✔ ${payload.detail}. Puedes refrescar la página en unos minutos para ver los resultados.`;
      } catch (error) {
        syncStatus.textContent = `✖ ${error.message}`;
      }
    });
  }
</script>
{% endblock %}
{% endblock %}
