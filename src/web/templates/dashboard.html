{% extends "base.html" %}

{% block title %}Resumen de Inventario · Inventario Contifico{% endblock %}

{% block content %}
<section class="hero">
  <h2 class="hero__title">Resumen del inventario sincronizado</h2>
  <p class="hero__subtitle">
    Consulta el estado actual de los catálogos y documentos obtenidos desde Contífico.
  </p>
</section>

<section class="sync">
  <h2>Sincroniza tu inventario</h2>
  <p>
    Lanza una sincronización inmediata contra la API de Contífico para refrescar los datos
    almacenados en esta instancia.
  </p>
  <form id="sync-form" class="sync__form">
    <label class="sync__label" for="since">Importar cambios desde (opcional)</label>
    <input
      id="since"
      name="since"
      type="datetime-local"
      class="sync__input"
      placeholder="2024-01-01T00:00"
    />
    <fieldset class="sync__fieldset">
      <legend>¿Qué deseas sincronizar?</legend>
      <p class="sync__hint">Deja las casillas vacías para importar todos los módulos.</p>
      <div class="sync__options">
        {% for option in resource_options %}
        <label class="sync__checkbox">
          <input type="checkbox" name="resources" value="{{ option.slug }}" />
          <span>{{ option.label }}</span>
        </label>
        {% endfor %}
      </div>
      <div class="sync__actions">
        <button type="button" class="sync__toggle" data-action="select-all">
          Seleccionar todo
        </button>
        <button type="button" class="sync__toggle" data-action="clear-all">
          Limpiar selección
        </button>
      </div>
    </fieldset>
    <label class="sync__checkbox sync__checkbox--single">
      <input type="checkbox" name="full_refresh" value="1" />
      <span>Descargar todo otra vez (ignora la última sincronización)</span>
    </label>
    <button type="submit" class="sync__button">Sincronizar ahora</button>
  </form>
  <p id="sync-status" class="sync__status" role="status"></p>
</section>

<section class="lookup">
  <h2>Busca registros descargados</h2>
  <p>
    Valida la sincronización consultando los últimos registros o buscando por identificador o
    palabra clave en los datos descargados.
  </p>
  <form id="lookup-form" class="lookup__form">
    <label class="lookup__label" for="lookup-resource">Recurso</label>
    <select id="lookup-resource" name="resource" class="lookup__input" required>
      <option value="" disabled selected>Selecciona un recurso</option>
      {% for option in resource_options %}
      <option value="{{ option.slug }}">{{ option.label }}</option>
      {% endfor %}
    </select>
    <label class="lookup__label" for="lookup-query">Término de búsqueda (opcional)</label>
    <input
      id="lookup-query"
      name="query"
      type="text"
      class="lookup__input"
      placeholder="ID exacto o palabra clave"
    />
    <button type="submit" class="lookup__button">Buscar</button>
  </form>
  <div id="lookup-status" class="lookup__status" role="status"></div>
  <div id="lookup-results" class="lookup__results" hidden>
    <h3 class="lookup__results-title">Coincidencias</h3>
    <ul class="lookup__list"></ul>
  </div>
</section>

<section class="cards">
  {% for resource in resources %}
  <article class="card">
    <header class="card__header">
      <h3>{{ resource.label }}</h3>
      <span class="card__count">{{ resource.count }}</span>
    </header>
    <dl class="card__meta">
      <div>
        <dt>Última actualización (API)</dt>
        <dd>{{ resource.last_updated or "Sin datos" }}</dd>
      </div>
      <div>
        <dt>Última captura (local)</dt>
        <dd>{{ resource.last_fetched or "Sin datos" }}</dd>
      </div>
      <div>
        <dt>Última sincronización</dt>
        <dd>{{ resource.last_synced or "Sin registros" }}</dd>
      </div>
    </dl>
  </article>
  {% endfor %}

  {% if not has_data %}
  <article class="card card--empty">
    <h3>Aún no hay datos</h3>
    <p>
      Realiza una sincronización desde el panel para poblar la base local y comenzar a construir
      análisis desde este panel.
    </p>
  </article>
  {% endif %}
</section>

<section class="upcoming">
  <h2>Próximas funcionalidades</h2>
  <p>Estas ideas guiarán los análisis y visualizaciones que añadiremos sobre el inventario.</p>
  <ul class="upcoming__list">
    {% for item in upcoming %}
    <li>
      <h3>{{ item.title }}</h3>
      <p>{{ item.description }}</p>
    </li>
    {% endfor %}
  </ul>
</section>

{% block scripts %}
<script>
  const syncForm = document.querySelector('#sync-form');
  const syncStatus = document.querySelector('#sync-status');
  const lookupForm = document.querySelector('#lookup-form');
  const lookupStatus = document.querySelector('#lookup-status');
  const lookupResults = document.querySelector('#lookup-results');
  const lookupList = lookupResults ? lookupResults.querySelector('.lookup__list') : null;

  if (syncForm) {
    syncForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      syncStatus.textContent = 'Lanzando sincronización…';

      const formData = new FormData(syncForm);
      const params = new URLSearchParams();
      const since = formData.get('since');
      if (since) {
        params.append('since', since);
      }
      formData
        .getAll('resources')
        .filter((value) => value)
        .forEach((value) => params.append('resources', value));
      if (formData.get('full_refresh')) {
        params.append('full_refresh', 'true');
      }

      try {
        const queryString = params.toString();
        const response = await fetch(`/api/sync${queryString ? `?${queryString}` : ''}`, {
          method: 'POST',
        });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'No se pudo iniciar la sincronización');
        }
        const payload = await response.json();
        syncStatus.textContent = `✔ ${payload.detail}. Puedes refrescar la página en unos minutos para ver los resultados.`;
      } catch (error) {
        syncStatus.textContent = `✖ ${error.message}`;
      }
    });

    const toggleButtons = syncForm.querySelectorAll('.sync__toggle');
    const resourceCheckboxes = syncForm.querySelectorAll('input[name="resources"]');
    toggleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const action = button.dataset.action;
        resourceCheckboxes.forEach((checkbox) => {
          if (action === 'select-all') {
            checkbox.checked = true;
          }
          if (action === 'clear-all') {
            checkbox.checked = false;
          }
        });
      });
    });
  }

  if (lookupForm && lookupStatus && lookupResults && lookupList) {
    lookupForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(lookupForm);
      const resource = formData.get('resource');
      const query = formData.get('query');
      if (!resource) {
        lookupStatus.textContent = 'Selecciona un recurso para buscar.';
        return;
      }

      lookupStatus.textContent = 'Buscando…';
      lookupResults.hidden = true;
      lookupList.innerHTML = '';

      try {
        const params = new URLSearchParams();
        if (query) {
          params.append('q', query);
        }
        const response = await fetch(
          `/api/resource/${encodeURIComponent(resource)}${params.toString() ? `?${params}` : ''}`
        );
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.detail || 'No se pudo realizar la búsqueda');
        }
        const payload = await response.json();
        const { results } = payload;
        if (!results || results.length === 0) {
          lookupStatus.textContent = 'No se encontraron coincidencias con los criterios proporcionados.';
          return;
        }

        lookupStatus.textContent = `Se encontraron ${results.length} coincidencia(s).`;
        results.forEach((item) => {
          const element = document.createElement('li');
          element.classList.add('lookup__item');
          const title = document.createElement('h4');
          title.textContent = `ID: ${item.id}`;
          element.appendChild(title);
          const meta = document.createElement('p');
          meta.classList.add('lookup__meta');
          const updated = item.updated_at ? new Date(item.updated_at).toLocaleString() : 'Desconocido';
          const fetched = item.fetched_at ? new Date(item.fetched_at).toLocaleString() : 'Desconocido';
          meta.textContent = `Actualizado: ${updated} · Capturado: ${fetched}`;
          element.appendChild(meta);
          const pre = document.createElement('pre');
          pre.classList.add('lookup__payload');
          pre.textContent = JSON.stringify(item.data, null, 2);
          element.appendChild(pre);
          lookupList.appendChild(element);
        });
        lookupResults.hidden = false;
      } catch (error) {
        lookupStatus.textContent = `Error: ${error.message}`;
      }
    });
  }
</script>
{% endblock %}
{% endblock %}
